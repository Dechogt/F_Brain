name: ğŸ® Gaming Platform - Git Flow CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # =============================================
  # JOB 1: FRONTEND - Tests et qualitÃ©
  # =============================================
  frontend-quality:
    name: ğŸ¨ Frontend Quality Check
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'frontend') || contains(github.ref, 'feature/') || github.ref == 'refs/heads/develop'
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'yarn'
    
    - name: ğŸ”§ Install frontend dependencies
      working-directory: ./frontend
      run: yarn install --frozen-lockfile
    
    - name: ğŸ§¹ Lint frontend code
      working-directory: ./frontend
      run: |
        yarn lint || echo "âš ï¸ ESLint issues found"
    
    - name: ğŸ§ª Run frontend tests
      working-directory: ./frontend
      run: |
        yarn test:coverage || echo "âš ï¸ Some tests failed"
    
    - name: ğŸ“Š Upload frontend coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./frontend/coverage/lcov.info
        flags: frontend
        name: frontend-coverage

  # =============================================
  # JOB 2: BACKEND DJANGO - Tests et qualitÃ©
  # =============================================
  backend-quality:
    name: ğŸ Backend Django Quality Check
    runs-on: ubuntu-latest
    if: contains(github.event.head_commit.message, 'backend') || contains(github.ref, 'feature/') || github.ref == 'refs/heads/develop'
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: gaming_platform_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Install backend dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
    
    - name: ğŸ” Run Django checks
      working-directory: ./backend
      run: |
        python manage.py check
        python manage.py check --deploy
      env:
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/gaming_platform_test
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: False
    
    - name: ğŸ§ª Run Django tests
      working-directory: ./backend
      run: |
        python manage.py test --verbosity=2 --keepdb
      env:
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/gaming_platform_test
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: False
    
    - name: ğŸ“Š Generate coverage report
      working-directory: ./backend
      run: |
        coverage run --source='.' manage.py test
        coverage xml
      env:
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/gaming_platform_test
        SECRET_KEY: test-secret-key-for-ci
    
    - name: ğŸ“ˆ Upload backend coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./backend/coverage.xml
        flags: backend
        name: backend-coverage

  # =============================================
  # JOB 3: INTEGRATION TESTS - Frontend + Backend
  # =============================================
  integration-tests:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: [frontend-quality, backend-quality]
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main'
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: gaming_platform_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python for Django
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ“¦ Setup Node.js for Frontend
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'yarn'
    
    - name: ğŸ”§ Install all dependencies
      run: |
        # Backend
        cd backend
        pip install -r requirements.txt
        cd ..
        # Frontend
        cd frontend
        yarn install --frozen-lockfile
        cd ..
    
    - name: ğŸš€ Start Django server
      working-directory: ./backend
      run: |
        python manage.py migrate
        python manage.py collectstatic --noinput
        python manage.py runserver 8000 &
        sleep 10
      env:
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/gaming_platform_test
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: True
    
    - name: ğŸ§ª Run E2E tests
      working-directory: ./frontend
      run: |
        yarn build
        yarn test:e2e || echo "âš ï¸ E2E tests need to be implemented"
      env:
        VITE_API_BASE_URL: http://localhost:8000/api/v1

  # =============================================
  # JOB 4: BUILD & DEPLOY STAGING (develop branch)
  # =============================================
  deploy-staging:
    name: ğŸ§ª Deploy to Staging
    runs-on: ubuntu-latest
    needs: [frontend-quality, backend-quality]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'yarn'
    
    - name: ğŸ—ï¸ Build frontend for staging
      working-directory: ./frontend
      run: |
        yarn install --frozen-lockfile
        yarn build
      env:
        VITE_AUTH0_DOMAIN: ${{ secrets.STAGING_AUTH0_DOMAIN }}
        VITE_AUTH0_CLIENT_ID: ${{ secrets.STAGING_AUTH0_CLIENT_ID }}
        VITE_API_BASE_URL: ${{ secrets.STAGING_API_BASE_URL }}
    
    - name: ğŸš€ Deploy frontend to staging
      uses: netlify/actions/cli@master
      with:
        args: deploy --dir=frontend/dist --alias=staging-${{ github.sha }}
      env:
        NETLIFY_SITE_ID: ${{ secrets.STAGING_NETLIFY_SITE_ID }}
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
    
    - name: ğŸ Deploy Django to staging
      run: |
        echo "ğŸš€ Deploying Django backend to staging..."
        # Exemple avec Heroku
        # heroku login --interactive
        # git push heroku-staging develop:main
        # Ou autre mÃ©thode de dÃ©ploiement
    
    - name: ğŸ“§ Notify team - Staging deployed
      if: success()
      run: |
        echo "âœ… Gaming Platform staging deployed successfully!"
        echo "ğŸ”— Frontend: https://staging-${{ github.sha }}--your-site.netlify.app"
        echo "ğŸ”— Backend: https://your-staging-api.herokuapp.com"

  # =============================================
  # JOB 5: DEPLOY PRODUCTION (main branch)
  # =============================================
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: production
      url: https://your-gaming-platform.com
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'yarn'
    
    - name: ğŸ—ï¸ Build frontend for production
      working-directory: ./frontend
      run: |
        yarn install --frozen-lockfile
        yarn build
      env:
        VITE_AUTH0_DOMAIN: ${{ secrets.PROD_AUTH0_DOMAIN }}
        VITE_AUTH0_CLIENT_ID: ${{ secrets.PROD_AUTH0_CLIENT_ID }}
        VITE_API_BASE_URL: ${{ secrets.PROD_API_BASE_URL }}
    
    - name: ğŸš€ Deploy frontend to production
      uses: netlify/actions/cli@master
      with:
        args: deploy --prod --dir=frontend/dist
      env:
        NETLIFY_SITE_ID: ${{ secrets.PROD_NETLIFY_SITE_ID }}
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
    
    - name: ğŸ Deploy Django to production
      run: |
        echo "ğŸš€ Deploying Django backend to production..."
        # Exemple avec Heroku
        # heroku login --interactive
        # git push heroku main
        # heroku run python manage.py migrate
        # heroku run python manage.py collectstatic --noinput
    
    - name: ğŸ·ï¸ Create release tag
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a "v$(date +'%Y.%m.%d')" -m "Release $(date +'%Y.%m.%d')"
        git push origin --tags
    
    - name: ğŸ“§ Notify team - Production deployed
      if: success()
      run: |
        echo "ğŸ‰ Gaming Platform production deployed successfully!"
        echo "ğŸ”— Live site: https://your-gaming-platform.com"

  # =============================================
  # JOB 6: SECURITY & PERFORMANCE (main branch)
  # =============================================
  security-performance:
    name: ğŸ”’ Security & Performance
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ” Frontend security audit
      working-directory: ./frontend
      run: |
        npm audit --audit-level moderate || echo "âš ï¸ Frontend vulnerabilities found"
    
    - name: ğŸ Backend security check
      working-directory: ./backend
      run: |
        pip install safety
        safety check || echo "âš ï¸ Backend vulnerabilities found"
    
    - name: âš¡ Lighthouse performance check
      uses: treosh/lighthouse-ci-action@v10
      with:
        configPath: './frontend/.lighthouserc.json'
        uploadArtifacts: true
        temporaryPublicStorage: true