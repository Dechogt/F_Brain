name: ğŸ® Gaming Followers CI/CD

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # =============================================
  # JOB 1: FRONTEND - Tests et qualitÃ© (Yarn)
  # =============================================
  frontend-tests:
    name: ğŸ¨ Frontend Tests
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'yarn'
        cache-dependency-path: './client/yarn.lock'

    - name: ğŸ”§ Install dependencies with Yarn
      working-directory: ./client
      run: yarn install --frozen-lockfile

    - name: ğŸ§¹ Lint code
      working-directory: ./client 
      run: yarn lint
      continue-on-error: true

    - name: ğŸ§ª Run tests
      working-directory: ./client
      run: yarn test
      continue-on-error: true

    - name: ğŸ—ï¸ Build project
      working-directory: ./client 
      run: yarn build
      continue-on-error: true

  # ================================
  # JOB 2: BACKEND DJANGO (Poetry)
  # ================================
  backend-tests:
    name: ğŸ Backend Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      id: setup-python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
        installer-parallel: true

    - name: ğŸ”§ Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}
     # working-directory: ./server <--   pour le cache si poetry.lock est dans backend

    - name: ğŸ”§ Install dependencies with Poetry
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      working-directory: ./server 
      run: poetry install --no-interaction --no-root

    - name: ğŸ§ª Run Django checks
      working-directory: ./server 
      run: |
        # Simplifie la logique, car tu es dÃ©jÃ  dans le rÃ©pertoire server
        poetry run python manage.py check
        echo "âœ… Django checks passed"
      continue-on-error: true

    - name: ğŸ§ª Run Django tests
      working-directory: ./server 
      run: |
        # Simplifie la logique, car tu es dÃ©jÃ  dans le rÃ©pertoire server
        poetry run python manage.py test
        echo "âœ… Django tests passed"
      continue-on-error: true

  # ====================================
  # JOB 3: DEPLOY STAGING (branche dev)
  # ====================================
  deploy-staging:
    name: ğŸ§ª Deploy to Staging
    runs-on: ubuntu-latest
    needs: [frontend-tests]
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'yarn'
        cache-dependency-path: './client/yarn.lock'

    - name: ğŸ—ï¸ Build for staging with Yarn
      working-directory: ./client 
      run: |
        yarn install --frozen-lockfile
        yarn build
      env:
        VITE_AUTH0_DOMAIN: ${{ secrets.STAGING_AUTH0_DOMAIN }}
        VITE_AUTH0_CLIENT_ID: ${{ secrets.STAGING_AUTH0_CLIENT_ID }}
        VITE_API_BASE_URL: ${{ secrets.STAGING_API_BASE_URL }}

    - name: ğŸ“¦ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: staging-build
        path: client/dist/ 
        if-no-files-found: warn

    - name: ğŸš€ Deploy notification
      run: |
        echo "ğŸ‰ Staging deployment completed!"
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"

  # =============================================
  # JOB 4: DEPLOY PRODUCTION (branche main)
  # =============================================
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'yarn'
        cache-dependency-path: './client/yarn.lock'

    - name: ğŸ—ï¸ Build for production with Yarn
      working-directory: ./client
      run: |
        yarn install --frozen-lockfile
        yarn build
      env:
        VITE_AUTH0_DOMAIN: ${{ secrets.PROD_AUTH0_DOMAIN }}
        VITE_AUTH0_CLIENT_ID: ${{ secrets.PROD_AUTH0_CLIENT_ID }}
        VITE_API_BASE_URL: ${{ secrets.PROD_API_BASE_URL }}

    - name: ğŸ“¦ Upload production artifacts
      uses: actions/upload-artifact@v4
      with:
        name: production-build
        path: client/dist/ # <-- Ajuste le chemin si nÃ©cessaire

    - name: ğŸ‰ Production deployment
      run: |
        echo "ğŸš€ Production deployment completed!"
        echo "Live at: https://gaming_followers.com"